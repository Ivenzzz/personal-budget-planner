<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | Budget Planner</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min (7).css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body class="bg-light d-flex align-items-center justify-content-center min-vh-100"
  style="background: linear-gradient(to bottom right, #dbeafe, white, #bfdbfe);">

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
          <div class="row g-0">

            <!-- Left Branding / Image Area -->
            <div class="col-md-6 d-none d-md-flex bg-primary text-white align-items-center justify-content-center p-4">
              <div class="text-center">
                <h2 class="fw-bold mb-2">Welcome!</h2>
                <p class="small">Manage your personal budget with ease.</p>
              </div>
            </div>

            <!-- Right Form Area -->
            <div class="col-md-6 bg-white p-4 p-md-5">
              <!-- LOGIN FORM -->
              <div id="loginForm">
                <h2 class="h4 fw-semibold text-center text-secondary mb-4">Login</h2>
                <form method="POST" class="needs-validation" novalidate>
                  <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" name="username" class="form-control" required>
                    <div class="invalid-feedback">Please enter your username.</div>
                  </div>
                  <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" name="password" class="form-control" required>
                    <div class="invalid-feedback">Please enter your password.</div>
                  </div>
                  <button type="submit" class="btn btn-primary w-100">Login</button>
                </form>
                <div class="mt-4 text-center small text-muted">
                  Don't have an account?
                  <a href="#" id="showRegister" class="text-primary text-decoration-none">Register here</a>
                </div>
              </div>

              <!-- REGISTER FORM (Hidden by default) -->
              <div id="registerForm" style="display: none;">
                <h2 class="h4 fw-semibold text-center text-secondary mb-4">Register</h2>
                <form id="registerFormElement" class="needs-validation" novalidate>
                  <div class="mb-3">
                    <label for="reg_username" class="form-label">Username</label>
                    <input type="text" id="reg_username" name="username" class="form-control" required>
                    <div class="invalid-feedback">Please enter a username.</div>
                  </div>
                  <div class="mb-3">
                    <label for="reg_password" class="form-label">Password</label>
                    <input type="password" id="reg_password" name="password" class="form-control" required>
                    <div class="invalid-feedback">Please enter a password.</div>
                  </div>
                  <div class="mb-3">
                    <label for="confirm_password" class="form-label">Confirm Password</label>
                    <input type="password" id="confirm_password" class="form-control" required>
                    <div class="invalid-feedback">Please confirm your password.</div>
                  </div>
                  <button type="submit" class="btn btn-success w-100">Register</button>
                </form>
                <div class="mt-4 text-center small text-muted">
                  Already have an account?
                  <a href="#" id="showLogin" class="text-primary text-decoration-none">Login here</a>
                </div>
              </div>

            </div>
            <!-- End Right Form Area -->

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Toggle between Login and Register
    document.getElementById("showRegister").addEventListener("click", function (e) {
      e.preventDefault();
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("registerForm").style.display = "block";
    });

    document.getElementById("showLogin").addEventListener("click", function (e) {
      e.preventDefault();
      document.getElementById("registerForm").style.display = "none";
      document.getElementById("loginForm").style.display = "block";
    });

    // Register form validation and submission
    const registerForm = document.getElementById("registerFormElement");
    const passwordField = document.getElementById("reg_password");
    const confirmPasswordField = document.getElementById("confirm_password");

    registerForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const username = document.getElementById("reg_username").value.trim();
      const password = passwordField.value.trim();
      const confirmPassword = confirmPasswordField.value.trim();

      // ✅ Check password match and mark invalid if not matched
      if (password !== confirmPassword) {
        confirmPasswordField.setCustomValidity("Passwords do not match");
        confirmPasswordField.classList.add("is-invalid");
        return; // Stop submission
      } else {
        confirmPasswordField.setCustomValidity(""); // Clear previous error
        confirmPasswordField.classList.remove("is-invalid");
        confirmPasswordField.classList.add("is-valid");
      }

      // ✅ Bootstrap validation for other fields
      if (!registerForm.checkValidity()) {
        registerForm.classList.add('was-validated');
        return;
      }

      fetch("/register-user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Registration successful!',
              text: 'Redirecting to login...',
              timer: 2000,
              showConfirmButton: false
            }).then(() => {
              document.getElementById("registerForm").style.display = "none";
              document.getElementById("loginForm").style.display = "block";
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Registration failed',
              text: data.message
            });
          }
        })
        .catch(err => {
          console.error("Registration error:", err);
          Swal.fire({
            icon: 'error',
            title: 'Unexpected error',
            text: 'Something went wrong. Please try again.'
          });
        });
    });

    // ✅ Bootstrap validation styling
    (function () {
      'use strict';
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    })();
  </script>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            {% for category, message in messages %}
            Swal.fire({
                icon: "{{ 'success' if category == 'success' else ('error' if category == 'danger' else 'info') }}",
                title: "{{ message }}",
                confirmButtonColor: "#3085d6",
                confirmButtonText: "OK"
            });
            {% endfor %}
        });
    </script>
    {% endif %}
    {% endwith %}



</body>

</html>